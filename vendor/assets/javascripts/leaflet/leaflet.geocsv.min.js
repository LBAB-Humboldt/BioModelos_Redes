/*
* Copyright 2013 - GPL
* Iv√°n Eixarch <ivan@sinanimodelucro.org>
* https://github.com/joker-x/Leaflet.geoCSV
*/
L.GeoCSV=L.GeoJSON.extend({options:{titles:["lat","lng","popup"],latitudeTitle:"lat",longitudeTitle:"lng",fieldSeparator:";",lineSeparator:"\n",deleteDoubleQuotes:!0,firstLineTitles:!1},_propertiesNames:[],initialize:function(a,b){L.Util.setOptions(this,b);L.GeoJSON.prototype.initialize.call(this,a,b)},addData:function(a){if("string"===typeof a){var b=this.options.titles;if(this.options.firstLineTitles){a=a.split(this.options.lineSeparator);if(2>a.length)return;b=a[0];a.splice(0,1);a=a.join(this.options.lineSeparator);
for(var b=b.trim().split(this.options.fieldSeparator),c=0;c<b.length;c++)b[c]=this._deleteDoubleQuotes(b[c]);this.options.titles=b}for(c=0;c<b.length;c++){var e=b[c].toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"_");if(""==e||"_"==e||0<=this._propertiesNames.indexOf(e))e="prop-"+c;this._propertiesNames[c]=e}a=this._csv2json(a)}L.GeoJSON.prototype.addData.call(this,a)},getPropertyName:function(a){a=this.options.titles.indexOf(a);var b="";0<=a&&(b=this._propertiesNames[a]);return b},getPropertyTitle:function(a){a=
this._propertiesNames.indexOf(a);var b="";0<=a&&(b=this.options.titles[a]);return b},_deleteDoubleQuotes:function(a){this.options.deleteDoubleQuotes&&(a=a.trim().replace(/^"/,"").replace(/"$/,""));return a},_csv2json:function(a){var b={type:"FeatureCollection",features:[]},c=this.options.titles;a=a.split(this.options.lineSeparator);for(var e=0;e<a.length;e++){var f=$.csv.toArray(a[e].trim()),d=parseFloat(f[c.indexOf(this.options.longitudeTitle)]),h=parseFloat(f[c.indexOf(this.options.latitudeTitle)]);
if(f.length==c.length&&180>d&&-180<d&&90>h&&-90<h){var g={type:"Feature",geometry:{},properties:{}};g.geometry.type="Point";g.geometry.coordinates=[d,h];for(d=0;d<c.length;d++)c[d]!=this.options.latitudeTitle&&c[d]!=this.options.longitudeTitle&&(g.properties[this._propertiesNames[d]]=this._deleteDoubleQuotes(f[d]));b.features.push(g)}}return b}});L.geoCsv=function(a,b){return new L.GeoCSV(a,b)};